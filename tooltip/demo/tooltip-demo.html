<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="x-tag-components.css"/>
    <link rel="stylesheet" type="text/css" href="../src/tooltip.css"/>
    
    <script type="text/javascript" src="x-tag-components.js"></script>
    <script type="text/javascript" src="../src/tooltip.js"></script>
    <style>
        body, html{
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #container{
            border: 1px solid grey;
            margin: 0 auto;
            width: 320px;
            height: 480px;
            position: relative;
            overflow: auto;
        }
        
        #prev-sib{
            position: relative;
            margin: 1em;
            border: 1px solid grey;
            overflow: visible;
        }
        
        #next-sib{
            margin-top: 10em;
            background-color: cyan; 
            position: relative;
        }
        
        .fancy-selector{
            position: relative;
            display: inline-block;
            background-color: lightsteelblue;
            font-size: 1.2em;
            margin:.15em;
        }
        
        /* arrow is always in relation to content, so modify borders here instead
           of in the content element
           
           any border or background styles here will be inherited by the tooltip arrow
        */
        #demoTip{
            border-radius: 4px;
            border: 2px solid black;
            background: orange url('cream_pixels.png') center repeat repeat;
        }
        
        #demoTip > .tooltip-content{
            padding: .5em;
            font-family: Courier;
        }
        
        .demo-targeted{
            box-shadow: 1px 1px 10px goldenrod;
        }
        
        .demo-targeted:after{
            content: "!";
            position: absolute;
            right: -7px;
            bottom: -7px;
            background-color: red;
            color: white;
            font-size: 1.1em;
            border: 1px solid white;
            box-shadow: 1px 1px 4px grey;
            border-radius: 100%;
            width: 20px;
            height: 20px;
            text-align: center;
        }
        
        #controls{
            text-align: center;
        }
    </style>
</head>
<body>
<h1>X-ToolTip demo</h1>
<div id="container">
    parent node
    <button id="prev-sib">
        <p style="background-color: tomato; float:right;">prev sibling
            <img src="http://placecage.com/100/50"/>
        </p>
    </button>
    <x-tooltip id="demoTip" target-selector=".fancy-selector">
        <span class="fancy-selector">Hi!</span>I'm a tooltip! <img src="http://placecage.com/30/30"/>
        <br/><a href="http://google.com">Check out this link!</a>
    </x-tooltip>
    <div id="next-sib">
        <h1>Next sibling</h1>
    </div>
    <div style="position: relative; background-color: lavender">    
        <span class="fancy-selector">".fancy-selector" box1</span>
        <span class="fancy-selector">box2 <img src="http://placecage.com/c/50/25"/></span>
    </div>
</div>


<div id="controls">
    <div id="demo-tip-controls">
        <button onClick="changeOrientation()">Change orientation</button>
        <button onClick="toggleTooltip()">Toggle tooltip</button>
        <button onClick="toggleSelector()">Toggle selector</button>
        <button onClick="toggleTriggerStyle()">Toggle trigger style</button>
        <button onClick="toggleIgnoreOuter()">Toggle ignore-outer-trigger</button>
        <button onClick="changeContents()">Change tooltip contents</button>
        <button onClick="toggleTooltipPointerEvents()">Toggle tooltip pointer events</button>
    </div>
    <br/>
    <span>Current selector = <span id="curr-selector-status"></span></span>
    <br/>
    <span>Current orientation = <span id="curr-orient-status"></span></span>
    <br/>
    <span>Current trigger style = <span id="curr-trigger-style-status"></span></span>
    <br/>
    <span>Outer triggering = <span id="outer-trigger-status"></span></span>
    <br/>
    <span>Tooltip pointer events = <span id="tooltip-pointer-events-status"></span></span>
    <br/>
    <button onClick="addFancySpan()">Add fancy-selector box</span>
    <button onClick="addRemoveTooltip()">Add / remove tooltip</button>
</div>
<script>
var demoTip;
var TRIGGER_STYLES = ["hover", "click", "touchstart", "tap", "none"];
var ORIENTS = ["auto", "top", "right", "bottom", "left"];
var CSS_SELECTORS = [".fancy-selector", "#next-sib", ".fancy-selector img",
                     "#container"];

document.addEventListener('DOMComponentsLoaded', function(){
    demoTip = document.getElementById("demoTip");
    updateStatuses();
    
    demoTip.addEventListener("tooltipshown", function(e){
        console.log("tooltip shown!");
    });
    
    demoTip.addEventListener("tooltiphidden", function(e){
        console.log("tooltip hidden!");
    });
});

function addRemoveTooltip(){
    var container = document.getElementById("container");
    var nextSib = document.getElementById("next-sib");
    if(document.getElementById("demoTip")){
        container.removeChild(demoTip);
    }
    else{
        container.insertBefore(demoTip, nextSib);
    }
    updateStatuses();
}

function randomWord(len){
    var output = "";
    var aCode = "A".charCodeAt(0);
    for(var i=0; i < len; i++){
        var letterCode = aCode + Math.floor(Math.random() * 26);
        var letter = String.fromCharCode(letterCode);
        
        if(Math.random() > 0.5){
            letter = letter.toLowerCase();
        }
        output += letter;
    }
    return output;
}

function addFancySpan(){
    var container = document.getElementById("container");
    
    var newSpan = document.createElement("span");
    xtag.addClass(newSpan, "fancy-selector");
    newSpan.textContent = randomWord(6);
    
    container.appendChild(newSpan);
    
    updateStatuses();
}

function toggleTooltipPointerEvents(){
    demoTip.ignoreTooltipPointerEvents = !demoTip.ignoreTooltipPointerEvents;
    updateStatuses();
}

function changeOrientation(){
    var orients = ORIENTS;
    var currOrient = demoTip.orientation;
    
    var currIndex = orients.indexOf(currOrient);
    
    demoTip.setAttribute("orientation", orients[(currIndex+1) % orients.length]);
    updateStatuses();
}

function toggleTooltip(){
    demoTip.toggle();
}

function toggleIgnoreOuter(){
    demoTip.ignoreOuterTrigger = !demoTip.ignoreOuterTrigger;
    updateStatuses();
}

function toggleSelector(){
    var selectors = ["_previousSibling", "_nextSibling", ".fancy-selector"];
    var currSelector = demoTip.targetSelector;
    
    var currIndex = selectors.indexOf(currSelector);
    
    demoTip.targetSelector = selectors[(currIndex+1) % selectors.length];
    updateStatuses();
}

function toggleTriggerStyle(){
    var styles = TRIGGER_STYLES;
    var currStyle = demoTip.triggerStyle;
    
    var currIndex = styles.indexOf(currStyle);
    
    demoTip.triggerStyle = styles[(currIndex+1) % styles.length];
    
    updateStatuses();
}

function updateStatuses(){
    updateSelectorBox();
    updateOrientationBox();
    updateTriggerStyleBox();
    updateIgnoreOuterStatus();
    updateTooltipPointerEventsStatus();
    
    var oldTargets = xtag.query(document, ".demo-targeted");
    var targets = demoTip.targetElems;
    
    oldTargets.forEach(function(oldTarg){
        xtag.removeClass(oldTarg, "demo-targeted");
    });
    
    if(demoTip.parentNode){
        targets.forEach(function(targ){
            xtag.addClass(targ, "demo-targeted");
        });
    }
    
    
    var buttons = document.querySelectorAll("#demo-tip-controls button");
    buttons.forEach(function(button){
        if(demoTip.parentNode){
            button.removeAttribute("disabled");
        }
        else{
            button.setAttribute("disabled", true);
        }
    });
}

function updateTooltipPointerEventsStatus(){
    var statusBox = document.getElementById("tooltip-pointer-events-status");
    if(demoTip.parentNode){
        statusBox.textContent = (demoTip.ignoreTooltipPointerEvents) ? "ignored" : "enabled";
    }
    else{
        statusBox.textContent = "N/A";
    }
}

function updateIgnoreOuterStatus(){
    var statusBox = document.getElementById("outer-trigger-status");
    if(demoTip.parentNode){
        statusBox.textContent = (demoTip.ignoreOuterTrigger) ? "ignored" : "active";
    }
    else{
        statusBox.textContent = "N/A";
    }
}

function updateSelectorBox(){
    var statusBox = document.getElementById("curr-selector-status");
    if(demoTip.parentNode){
        statusBox.textContent = demoTip.targetSelector;
    }
    else{
        statusBox.textContent = "N/A";
    }
}

function updateOrientationBox(){
    var statusBox = document.getElementById("curr-orient-status");
    if(demoTip.parentNode){
        statusBox.textContent = demoTip.orientation;
    }
    else{
        statusBox.textContent = "N/A";
    }
}

function updateTriggerStyleBox(){
    var statusBox = document.getElementById("curr-trigger-style-status");
    if(demoTip.parentNode){
        statusBox.textContent = demoTip.triggerStyle;
        
        if(demoTip.presetTriggerStyles.indexOf(demoTip.triggerStyle) !== -1){
            statusBox.textContent += "  (preset style)";
        }
    }
    else{
        statusBox.textContent = "N/A";
    }
}

var changeContents = (function(){
    var currIndex = 0;
    var htmlStrs = [
        document.getElementById("demoTip").innerHTML,
        "Text text text text",
        "<img src='test.png'/>",
        "<img src='test.gif'/>",
        (function(){
            var aCode = "A".charCodeAt(0);
            var letters = [];
            for(var i=0; i < 10; i++){
                letters.push(String.fromCharCode(aCode+i));
            }
            return letters.join("<hr/>");
        })()
    ];
    
    return function(newIndex){
        var contentEl = demoTip.content;
        
        if(newIndex == undefined){
            newIndex = (currIndex+1) % htmlStrs.length;
        }
        currIndex = newIndex;
        var newHtml = htmlStrs[newIndex];
        
        // set up a temporary holding element to load images in
        var container = document.createElement("div");
        container.innerHTML = newHtml;
        
        var imgs = container.querySelectorAll("img");
        var numImgs = imgs.length;
        var loadedImgs = 0;
        
        // copy over html from the temp container to the content element and
        // trigger a refresh
        var _onContainerReady = function(){
            contentEl.innerHTML = container.innerHTML;
            demoTip.refreshPosition();
        };
        
        if(numImgs === 0){
            _onContainerReady();
        }
        else{
            // wait for any images to load before setting the content's html
            var _onImgLoaded = function(){
                loadedImgs += 1;
                if(loadedImgs === numImgs){
                    _onContainerReady();
                }
            };
        
            imgs.forEach(function(img){
                if(img.complete){
                    _onImgLoaded();
                }
                else{
                    img.onload = _onImgLoaded;
                }
            });
        }
    }
})();
</script>
</body>
</html>